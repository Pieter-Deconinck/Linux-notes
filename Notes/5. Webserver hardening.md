9-11-2022 + 15-11-2022

# 5.4 Labo-oefeningen - Pieter Dc

## MariaDB IP-adres veranderen

- Mariadb config location

        /etc/my.cnf 
        /etc/my.cnf.d/mariadb-server.cnf (use this one)

- Verifieer ip address en poortnummer van mariadb

        ss -tl
        local address is *

        ss -tln
        mariadb(mysql) luistert op 3306

- Open het configuratiebestand. Plaats bij de sectie [server] in het bestand een variabele bind_address, en zet de waarde op het "intnet"IP-address van je server. Herstart de service, en verifiëer met de ss dat de mariadb service enkel nog actief is op dit ip-address.

        sudo nano /etc/my.cnf.d/mariadb-server.cnf
        sudo systemctl restart mariadb
        sudo ss -tl

- Installeer de package netcat. Maak een test-verbinding met de mariadb server: nc - nvz [ip-adres] 3306. Test dit eveneens met de twee andere ip addressen van je server (NAT, localhost). Verifieer dat dit niet langer werkt!


        sudo dnf install nmap
        nc -nvz 192.168.76.12 3306


## MariaDB poortnummer veranderen

- 3306 is een te publiek gekende poort - en trekt gemakkelijk online de aandacht van hackers. Laten we een alternatieve poort zoeken: welk poortnummer vind je in /etc/services terug voor het niet langer gebruikte UniSQL protocol? Noteer


        sudo cat /etc/services | grep UniSQL
        poort nummer: 1978

- Bewerkt opnieuw het mysql configuratiebestand, en plaats een waarde port onder het IP-adres van hierboven. Stel op deze manier het poortnummer in op dit van UniSQL.Herstart de mariadb service.


        sudo nano /etc/my.cnf.d/mariadb-server.cnf
        port=1978
        sudo systemctl restart mariadb (should give an error)

- Als alles goed gaat, zal je mariadb server niet opstarten! Immers: SELinux laat slechts een beperkt aantal poorten toe voor MariaDB. Ga op https://dev.mysql.com/doc/refman/8.0/en/selinux-context-mysqld-tcp-port.html na hoe je het hierboven gekozen poortnummer kan toevoegen aan de juiste SELinux context. Herstart nu nogmaals je mariadb service - tot hij werkt.

        sudo semanage port -a -t mysqld_port_t -p tcp 1978
        sudo semanage port -l | grep mysql
        sudo systemctl restart mariadb
        sudo nc -nvz 192.168.76.12 1978

## MariaDB directory veranderen

- Standaard bewaart de DB server zijn data in de map /var/lib/mysql. Maak een map /dbdata aan op je server. Verander de eigenaar en de groep van deze map naar mysql:mysql - het is deze gebruiker die operaties uitvoert op de map als de service zaken verandert!

        cd /
        sudo mkdir dbdata
        sudo chown mysql:mysql dbdata/

- Wijzig in het config bestand de default locatie voor de database data naar deze map.

    sudo nano /etc/my.cnf.d/mariadb-server.cnf
    datadir=/dbdata

- Herstart de mariadb service. Als alles goed gaat, zal je mariadb server niet opstarten! Opnieuw gaan we ook SELinux nog moeten aanpassen opdat deze map gebruikt mag worden.
Ga na op https://mariadb.com/kb/en/selinux/ welke aanpassingen je nog moet uitvoeren op je nieuwe map. 

        sudo semanage fcontext -a -t mysqld_db_t "/dbdata(/.*)?"
        sudo restorecon -Rv /dbdata

        sudo systemctl restart mariadb


## mysql data input

- Stel een (mysql) root wachtwoord in voor deze server met mysqladmin password

        sudo mysqladmin password
        vagrant
        vagrant

- Verbind met de mysql server op de CLI met mysql -u root -p. Geef het gekozen wachtwoord in.

        sudo mysql -u root -p
        vagrant

- Maak een gebruiker aan die toegang krijgt tot een test-database. In SQL: 
CREATE DATABASE IF NOT EXISTS trialsite;
GRANT ALL ON trialsite.* TO 'www_user'@'%' identified by 'YourSitePassword';
FLUSH PRIVILEGES;

- Voer met deze nieuwe gebruiker een set van data in in jouw database:
mysql --user="www_user" --password="YourSitePassword" "trialsite" << _EOF_
DROP TABLE IF EXISTS trialsite_tbl;
CREATE TABLE trialsite_tbl (
  id int(5) NOT NULL AUTO_INCREMENT,
  name varchar(50) DEFAULT NULL,
  PRIMARY KEY(id)
);
INSERT INTO trialsite_tbl (name) VALUES ("Mr. IPtables");
INSERT INTO trialsite_tbl (name) VALUES ("Mrs. SELinux");
_EOF_

        invoeren in linux vm, niet in mariadb terminal

- Test je gecreëerde database met het volgende bash script test_db.sh. Je kan dit zelf aanmaken op je server system:

        cd 
        sudo mkdir scripts
        cd scripts/
        sudo nano test_db.sh

        #!/bin/bash
        test_database='trialsite'
        test_table='trialsite_tbl'
        test_user='www_user'
        test_password='YourSitePassword'

        mysql --host=192.168.76.12 --port=1978 \
        --user="${test_user}" \
        --password="${test_password}" \
        "${test_database}" \
        --execute="SELECT * FROM ${test_table};"

        sudo chmod 777 test_db.sh
        sudo ./test_db.sh